#!/usr/bin/env bash
# run_q.sh - Send a .q file to a running q process on localhost:5000
# Usage: ./run_q.sh script.q

set -euo pipefail

HOST="localhost"
PORT="5000"
Q_BIN="q"

error_exit() {
    echo "❌ Error: $1" >&2
    exit 1
}

if [[ $# -lt 1 ]]; then
    error_exit "No .q file provided. Usage: $0 script.q"
fi

SCRIPT_NAME="$1"

if [[ ! "$SCRIPT_NAME" =~ \.q$ ]]; then
    error_exit "File must have .q extension (got '$SCRIPT_NAME')."
fi

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
Q_FILE="$SCRIPT_DIR/$SCRIPT_NAME"

if [[ ! -f "$Q_FILE" ]]; then
    error_exit "File '$Q_FILE' not found."
fi

if ! command -v "$Q_BIN" >/dev/null 2>&1; then
    error_exit "q executable not found in PATH."
fi

echo "▶ Sending $Q_FILE to q on $HOST:$PORT"
"$Q_BIN" ":$HOST:$PORT" -c "$(cat "$Q_FILE")" || error_exit "Execution failed."
